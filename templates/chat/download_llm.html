{% extends 'base.html' %}
{% load static %}

{% block title %} Chat with LLM {% endblock title %}


{% block links %}
<link rel="stylesheet" href="{% static 'css/form.css' %}">

<style>
    h1, h2, th, td {
        color: #fff;
    }

    p {
        color: red;
        font-size: 12px;
    }

    th, td {
        padding: 10px 15px;
    }
</style>

{% endblock links %}


{% block content %}

<main class="flex-ctr-clm">
    <div class="container flex-clm-str">
        <div class="header flex-sp-bet" style="width: 90%; padding: 10px 10px 25px;">
            <a href="{% url 'chat_view_no_id' %}"> 
                <h2 class="logo">Chat with LLM</h2> 
            </a>
    
            <button id="mode" class="btn"><i class="fa-solid fa-moon"></i></button>
        </div>
    

        <h1>Download LLM</h1>
        <p>Enter the path of the LLM from Huging Face, <br> (Like : 'huawei-noah/TinyBERT_General_4L_312D')</p>
        <form method="POST" action="{% url 'download_llm' %}" class="flex-ctr-clm" style="padding-top: 0;">
            {% csrf_token %}
            <!-- <label for="llm_name">LLM Name:</label> -->
            <input type="text" id="llm_name" name="llm_name" placeholder="Enter model name (e.g., gpt2)">
            <button type="submit" class="btn">Download</button>
        </form>

        <hr width="50%" height="10px">

        <h2>Available LLM Models</h2>
        <table border="1">
            <thead>
                <tr>
                    <th>LLM Name</th>
                    <th>Downloaded</th>
                </tr>
            </thead>
            <tbody>
                {% for model in llm_models %}
                <tr>
                    <td>{{ model.llm_name }}</td>
                    <td>{{ model.is_downloaded|yesno:"Yes,No" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

    </div>
</main>

{% endblock content %}


{% block scripts %}
<script>
function handleDownload(event) {
    event.preventDefault(); // Prevent form submission
    const llmPath = document.getElementById("llm_path").value;

    if (!llmPath) {
        alert("Please enter a valid LLM path.");
        return false;
    }

    // Show modal with a downloading message
    document.getElementById("modal-body").textContent = "Downloading the model...";
    $('#downloadModal').modal('show');

        // Send AJAX request to download the LLM
    fetch(`/api/download_llm/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ llm_path: llmPath })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById("modal-body").textContent = "Model downloaded successfully!";
            setTimeout(() => location.reload(), 2000);
        } else {
            document.getElementById("modal-body").textContent = `Error: ${data.error}`;
        }
    })
    .catch(error => {
        document.getElementById("modal-body").textContent = "An unexpected error occurred.";
        console.error("Error downloading model:", error);
    });

    return false; // Prevent form default submission
}
</script>
{% endblock scripts %}

